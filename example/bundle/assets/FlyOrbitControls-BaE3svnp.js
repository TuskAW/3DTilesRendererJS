import{G as _,ak as N,M as F,f as V,d as I,C as P,k as U,al as W,o as z}from"./three.module-CrM3Sdgj.js";import{S as j,a as q}from"./EllipsoidRegionHelper-D839MfHG.js";import{O as J}from"./OrbitControls-D8InQlht.js";const E=Symbol("ORIGINAL_MATERIAL"),k=Symbol("HAS_RANDOM_COLOR"),M=Symbol("HAS_RANDOM_NODE_COLOR"),v=Symbol("LOAD_TIME"),O=new I,L=()=>{},G={};function R(x){if(!G[x]){const e=Math.random(),t=.5+Math.random()*.5,i=.375+Math.random()*.25;G[x]=new P().setHSL(e,t,i)}return G[x]}const C=0,Q=1,X=2,Y=3,Z=4,$=5,ee=6,S=7,w=8,te=9,A=10;class le{constructor(e){e={displayBoxBounds:!1,displaySphereBounds:!1,displayRegionBounds:!1,colorMode:C,maxDebugDepth:-1,maxDebugDistance:-1,maxDebugError:-1,customColorCallback:null,...e},this.name="DEBUG_TILES_PLUGIN",this.tiles=null,this.extremeDebugDepth=-1,this.extremeDebugError=-1,this.boxGroup=null,this.sphereGroup=null,this.regionGroup=null,this.displayBoxBounds=e.displayBoxBounds,this.displaySphereBounds=e.displaySphereBounds,this.displayRegionBounds=e.displayRegionBounds,this.colorMode=e.colorMode,this.maxDebugDepth=e.maxDebugDepth,this.maxDebugDistance=e.maxDebugDistance,this.maxDebugError=e.maxDebugError,this.customColorCallback=e.customColorCallback,this.getDebugColor=(t,i)=>{i.setRGB(t,t,t)}}init(e){this.tiles=e;const t=e.group;this.boxGroup=new _,this.boxGroup.name="DebugTilesRenderer.boxGroup",t.add(this.boxGroup),this.boxGroup.updateMatrixWorld(),this.sphereGroup=new _,this.sphereGroup.name="DebugTilesRenderer.sphereGroup",t.add(this.sphereGroup),this.sphereGroup.updateMatrixWorld(),this.regionGroup=new _,this.regionGroup.name="DebugTilesRenderer.regionGroup",t.add(this.regionGroup),this.regionGroup.updateMatrixWorld(),this._onLoadTileSetCB=()=>{this._initExtremes()},this._onLoadModelCB=({scene:i,tile:a})=>{this._onLoadModel(i,a)},this._onDisposeModelCB=({tile:i})=>{this._onDisposeModel(i)},this._onUpdateAfterCB=()=>{this._onUpdateAfter()},this._onTileVisibilityChangeCB=({scene:i,tile:a,visible:h})=>{this._onTileVisibilityChange(a,h)},e.addEventListener("load-tile-set",this._onLoadTileSetCB),e.addEventListener("load-model",this._onLoadModelCB),e.addEventListener("dispose-model",this._onDisposeModelCB),e.addEventListener("update-after",this._onUpdateAfterCB),e.addEventListener("tile-visibility-change",this._onTileVisibilityChangeCB),e.traverse(i=>{i.cached.scene&&this._onLoadModel(i.cached.scene,i)}),e.visibleTiles.forEach(i=>{this._onTileVisibilityChange(i,!0)})}getTileInformationFromActiveObject(e){let t=null;return this.tiles.activeTiles.forEach(a=>{if(t)return!0;const h=a.cached.scene;h&&h.traverse(n=>{n===e&&(t=a)})}),t?{distanceToCamera:t.__distanceFromCamera,geometricError:t.geometricError,screenSpaceError:t.__error,depth:t.__depth,isLeaf:t.__isLeaf}:null}_initExtremes(){let e=-1;this.tiles.traverse(i=>{e=Math.max(e,i.__depth)});let t=-1;this.tiles.traverse(i=>{t=Math.max(t,i.geometricError)}),this.extremeDebugDepth=e,this.extremeDebugError=t}_onUpdateAfter(){const e=this.tiles;if(!e.root)return;this.boxGroup.visible=this.displayBoxBounds,this.sphereGroup.visible=this.displaySphereBounds,this.regionGroup.visible=this.displayRegionBounds;let t=-1;this.maxDebugDepth===-1?t=this.extremeDebugDepth:t=this.maxDebugDepth;let i=-1;this.maxDebugError===-1?i=this.extremeDebugError:i=this.maxDebugError;let a=-1;this.maxDebugDistance===-1?(e.getBoundingSphere(O),a=O.radius):a=this.maxDebugDistance;const h=this.errorTarget,n=this.colorMode,d=e.visibleTiles;let s;n===A&&(s=Array.from(d).sort((r,u)=>r[v]-u[v])),d.forEach(r=>{const u=r.cached.scene;let b,f,g;n===S&&(b=Math.random(),f=.5+Math.random()*.5,g=.375+Math.random()*.25),u.traverse(o=>{n===w&&(b=Math.random(),f=.5+Math.random()*.5,g=.375+Math.random()*.25);const D=o.material;if(D){const y=o[E];if(n===C&&D!==y)o.material.dispose(),o.material=o[E];else if(n!==C&&D===y)if(o.isPoints){const l=new N;l.size=y.size,l.sizeAttenuation=y.sizeAttenuation,o.material=l}else o.material=new F,o.material.flatShading=!0;switch(n!==S&&delete o.material[k],n!==w&&delete o.material[M],n){case Z:{const l=r.__depth/t;this.getDebugColor(l,o.material.color);break}case $:{const l=r.__depthFromRenderedParent/t;this.getDebugColor(l,o.material.color);break}case Q:{const l=r.__error/h;l>1?o.material.color.setRGB(1,0,0):this.getDebugColor(l,o.material.color);break}case X:{const l=Math.min(r.geometricError/i,1);this.getDebugColor(l,o.material.color);break}case Y:{const l=Math.min(r.__distanceFromCamera/a,1);this.getDebugColor(l,o.material.color);break}case ee:{!r.children||r.children.length===0?this.getDebugColor(1,o.material.color):this.getDebugColor(0,o.material.color);break}case w:{o.material[M]||(o.material.color.setHSL(b,f,g),o.material[M]=!0);break}case S:{o.material[k]||(o.material.color.setHSL(b,f,g),o.material[k]=!0);break}case te:{this.customColorCallback?this.customColorCallback(r,o):console.warn("DebugTilesRenderer: customColorCallback not defined");break}case A:{const l=s.indexOf(r);this.getDebugColor(l/(s.length-1),o.material.color);break}}}})})}_onTileVisibilityChange(e,t){const i=e.cached,a=this.sphereGroup,h=this.boxGroup,n=this.regionGroup,d=i.boxHelperGroup,s=i.sphereHelper,r=i.regionHelper;t?(d&&(h.add(d),d.updateMatrixWorld(!0)),s&&(a.add(s),s.updateMatrixWorld(!0)),r&&(n.add(r),r.updateMatrixWorld(!0))):(d&&h.remove(d),s&&a.remove(s),r&&n.remove(r))}_onLoadModel(e,t){t[v]=performance.now();const i=this.tiles,a=t.cached,{sphere:h,obb:n,region:d}=a.boundingVolume;if(n){const s=new _;s.name="DebugTilesRenderer.boxHelperGroup",s.matrix.copy(n.transform),s.matrixAutoUpdate=!1;const r=new V(n.box,R(t.__depth));r.raycast=L,s.add(r),a.boxHelperGroup=s,i.visibleTiles.has(t)&&this.displayBoxBounds&&(this.boxGroup.add(s),s.updateMatrixWorld(!0))}if(h){const s=new j(h,R(t.__depth));s.raycast=L,a.sphereHelper=s,i.visibleTiles.has(t)&&this.displaySphereBounds&&(this.sphereGroup.add(s),s.updateMatrixWorld(!0))}if(d){const s=new q(d,R(t.__depth));s.raycast=L;const r=new I;d.getBoundingSphere(r),s.position.copy(r.center),r.center.multiplyScalar(-1),s.geometry.translate(...r.center),a.regionHelper=s,i.visibleTiles.has(t)&&this.displayRegionBounds&&(this.regionGroup.add(s),s.updateMatrixWorld(!0))}e.traverse(s=>{const r=s.material;r&&(s[E]=r)})}_onDisposeModel(e){const t=e.cached;t.boxHelperGroup&&(t.boxHelperGroup.children[0].geometry.dispose(),delete t.boxHelperGroup),t.sphereHelper&&(t.sphereHelper.geometry.dispose(),delete t.sphereHelper),t.regionHelper&&(t.regionHelper.geometry.dispose(),delete t.regionHelper)}dispose(){const e=this.tiles;e.removeEventListener("load-tile-set",this._onLoadTileSetCB),e.removeEventListener("load-model",this._onLoadModelCB),e.removeEventListener("dispose-model",this._onDisposeModelCB),e.removeEventListener("update-after",this._onUpdateAfterCB),this.colorMode=C,this._onUpdateAfter(),e.traverse(t=>{this._onDisposeModel(t)}),this.boxGroup.removeFromParent(),this.sphereGroup.removeFromParent(),this.regionGroup.removeFromParent()}}const se={type:"fly-change"},re={type:"fly-start"},ie={type:"fly-end"},p=new W(0,0,0,0);class he extends J{constructor(e,t){const i=c=>{this.enabled&&Object.defineProperty(c,"shiftKey",{get(){return!1}})};t.addEventListener("pointerdown",i),super(e,t),this.enableKeys=!1,this.enableFlight=!0,this.baseSpeed=1,this.fastSpeed=4,this.forwardKey="w",this.backKey="s",this.leftKey="a",this.rightKey="d",this.upKey="q",this.downKey="e",this.fastKey="shift";let a=!1,h=!1,n=!1,d=!1,s=!1,r=!1,u=!1,b=0,f=0,g=0,o=-1;const D=new U,y=new z,l=()=>{if(o!==-1){cancelAnimationFrame(o),o=-1,this.minDistance=f,this.maxDistance=g;const c=Math.min(b,e.position.distanceTo(D));p.set(0,0,-1,0).applyMatrix4(e.matrixWorld),this.target.copy(e.position).addScaledVector(p,c),this.dispatchEvent(ie)}},H=()=>{if(!this.enabled||!this.enableFlight)return;o=requestAnimationFrame(H),p.set(0,0,0,0),h&&(p.z-=1),n&&(p.z+=1),d&&(p.x-=1),s&&(p.x+=1),r&&(p.y+=1),u&&(p.y-=1),p.applyMatrix4(e.matrixWorld);const c=60*y.getDelta(),m=a?this.fastSpeed:this.baseSpeed;e.position.addScaledVector(p,m*c),this.target.addScaledVector(p,m*c),this.dispatchEvent(se)},T=c=>{const m=c.key.toLowerCase();switch(o===-1&&(g=this.maxDistance,f=this.minDistance,b=e.position.distanceTo(this.target),D.copy(this.target)),m){case this.forwardKey:h=!0;break;case this.backKey:n=!0;break;case this.leftKey:d=!0;break;case this.rightKey:s=!0;break;case this.upKey:r=!0;break;case this.downKey:u=!0;break;case this.fastKey:a=!0;break}switch(m){case this.fastKey:case this.forwardKey:case this.backKey:case this.leftKey:case this.rightKey:case this.upKey:case this.downKey:c.stopPropagation(),c.preventDefault()}(h||n||d||s||r||u||a)&&(this.minDistance=.01,this.maxDistance=.01,p.set(0,0,-1,0).applyMatrix4(e.matrixWorld),this.target.copy(e.position).addScaledVector(p,.01),o===-1&&(this.dispatchEvent(re),y.getDelta(),H()))},B=c=>{const m=c.key.toLowerCase();switch(m){case this.fastKey:case this.forwardKey:case this.backKey:case this.leftKey:case this.rightKey:case this.upKey:case this.downKey:c.stopPropagation(),c.preventDefault()}switch(m){case this.forwardKey:h=!1;break;case this.backKey:n=!1;break;case this.leftKey:d=!1;break;case this.rightKey:s=!1;break;case this.upKey:r=!1;break;case this.downKey:u=!1;break;case this.fastKey:a=!1;break}h||n||d||s||r||u||a||l()},K=()=>{l()};this.blurCallback=K,this.keyDownCallback=T,this.keyUpCallback=B,this.disableShiftKeyCallback=i,this.domElement.addEventListener("blur",K),this.domElement.addEventListener("keydown",T),this.domElement.addEventListener("keyup",B)}dispose(){super.dispose(),this.domElement.removeEventListener("blur",this.blurCallback),this.domElement.removeEventListener("keydown",this.keyDownCallback),this.domElement.removeEventListener("keyup",this.keyUpCallback),this.domElement.removeEventListener("pointerdown",this.disableShiftKeyCallback)}}export{te as C,Y as D,he as F,X as G,ee as I,A as L,C as N,$ as R,Q as S,Z as a,S as b,w as c,le as d};
