import{B as Me}from"./B3DMLoader-aPf5svSz.js";import{P as ke}from"./PNTSLoader-BKmvYx0Z.js";import{I as Fe}from"./I3DMLoader-uk6OaXCg.js";import{C as Ue}from"./CMPTLoader-C0F-2Ze2.js";import{G as Ae}from"./GLTFExtensionLoader-Cf5SHTW2.js";import{p as P,G as Le,i as ce,k as b,aw as he,j as Ie,B as Be,d as Ee,aq as De,aF as Ve,aG as Oe,V as de,E as Ne,L as ze}from"./three.module-CrM3Sdgj.js";import{r as qe}from"./readMagicBytes-Da5ueiou.js";import{a as We}from"./lil-gui.module.min-C0dNwVk_.js";import{e as je}from"./GLTFLoader-DesqJ6ah.js";function K(i){let e;try{e=new URL(i,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}const ee=2**30;class Ge{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),o=e(s);return n<o?-1:n>o?1:0}):this._unloadPriorityCallback=e}constructor(){this.maxSize=800,this.minSize=600,this.minBytesSize=.3*ee,this.maxBytesSize=.4*ee,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.markUnusedQueued=!1,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this._unloadPriorityCallback=null,this.getMemoryUsageCallback=()=>0;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}add(e,t){this.markUnusedQueued&&this.markAllUnused();const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,o=this.itemList,r=this.callbacks,a=this.bytesMap;o.push(e),n.add(e),s.set(e,Date.now()),r.set(e,t);const l=this.getMemoryUsageCallback(e);return this.cachedBytes+=l,a.set(e,l),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,o=this.bytesMap,r=this.callbacks;if(s.has(e)){this.cachedBytes-=o.get(e),o.delete(e),r.get(e)(e);const a=n.indexOf(e);return n.splice(a,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e);const n=this.getMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){this.markUnusedQueued&&this.markAllUnused();const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear(),this.markUnusedQueued=!1,this.unloadingHandle!==-1&&(cancelAnimationFrame(this.unloadingHandle),this.unloadingHandle=-1)}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:o,usedSet:r,callbacks:a,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,f=n.length-r.size,_=Math.max(Math.min(n.length-t,f),0),p=this.cachedBytes-c,d=this.unloadPriorityCallback||this.defaultPriorityCallback;let m=!1;const y=_>0&&f>0||n.length>s;if(f&&this.cachedBytes>c||this.cachedBytes>h||y){n.sort((T,S)=>{const J=r.has(T),Pe=r.has(S);return J===Pe?-d(T,S):J?1:-1});const F=Math.max(t*e,_*e),U=Math.ceil(Math.min(F,f,_)),A=Math.max(e*p,e*c),L=Math.min(A,p);let u=0,v=0;for(;;){const T=n[u],S=l.get(T);if(!(u<U||v<L||this.cachedBytes-v-S>h||n.length-u>s)||u>=f&&this.cachedBytes-v-S<=h&&n.length-u<=s)break;v+=S,u++,l.delete(T),a.get(T)(T),o.delete(T),a.delete(T)}n.splice(0,u),this.cachedBytes-=v,m=u<_||v<p&&u<f,m=m&&u>0}m&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent(),this.markUnusedQueued=!0}))}}class te{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const o=(...l)=>t(...l).then(s).catch(n),r=this.items,a=this.callbacks;r.push(e),a.set(e,o),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const o=e.pop(),r=t.get(o);t.delete(o),r(o).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const I=0,B=1,H=2,G=3,q=4,W=6378137,Je=1/298.257223563,He=-(Je*W-W),_t=1736*1e3,gt=1738.1*1e3;function Z(i){return i===G||i===q}function M(i,e){return i.__lastFrameVisited===e&&i.__used}function ue(i,e){i.__lastFrameVisited!==e.frameCount&&(i.__lastFrameVisited=e.frameCount,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1,i.__inFrustum=e.tileInView(i),e.calculateError(i))}function fe(i,e){if(e.ensureChildrenArePreprocessed(i),ue(i,e),Y(i,e),!i.__hasRenderableContent){const t=i.children;for(let s=0,n=t.length;s<n;s++)fe(t[s],e)}}function pe(i,e){if(e.ensureChildrenArePreprocessed(i),me(i,e)&&M(i,e.frameCount)&&!i.__hasRenderableContent&&(!i.__hasContent||Z(i.__loadingState))){const s=i.children;for(let n=0,o=s.length;n<o;n++){const r=s[n];pe(r,e)}}else M(i,e.frameCount)&&!e.lruCache.isFull()&&e.queueTileForDownload(i)}function Y(i,e){i.__used||(i.__used=!0,e.lruCache.markUsed(i),e.stats.used++,i.__inFrustum===!0&&e.stats.inFrustum++)}function me(i,e){return!(i.__error<=e.errorTarget||e.maxDepth>0&&i.__depth+1>=e.maxDepth)}function _e(i,e=null,t=null,s=null,n=0){if(e&&e(i,s,n)){t&&t(i,s,n);return}const o=i.children;for(let r=0,a=o.length;r<a;r++)_e(o[r],e,t,i,n+1);t&&t(i,s,n)}function ge(i,e){if(e.ensureChildrenArePreprocessed(i),ue(i,e),!i.__inFrustum)return;if(!me(i,e)){Y(i,e);return}let t=!1,s=!1;const n=i.children;for(let o=0,r=n.length;o<r;o++){const a=n[o];ge(a,e),t=t||M(a,e.frameCount),s=s||a.__inFrustum}if(Y(i,e),t&&i.refine==="REPLACE")for(let o=0,r=n.length;o<r;o++){const a=n[o];fe(a,e)}}function be(i,e){const t=e.frameCount;if(!M(i,t))return;const s=i.children;let n=!1;for(let o=0,r=s.length;o<r;o++){const a=s[o];n=n||M(a,t)}if(!n)i.__isLeaf=!0;else{let o=!1,r=!0;for(let a=0,l=s.length;a<l;a++){const c=s[a];if(be(c,e),o=o||c.__wasSetVisible||c.__childrenWereVisible,M(c,t)){const h=c.__allChildrenLoaded||c.__hasRenderableContent&&Z(c.__loadingState)||!c.__hasContent&&c.children.length===0||c.__hasUnrenderableContent&&c.__loadingState===q;r=r&&h}}i.__childrenWereVisible=o,i.__allChildrenLoaded=r}}function ye(i,e){const t=e.stats;if(!M(i,e.frameCount))return;const s=e.lruCache;if(i.__isLeaf){i.__loadingState===G?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):!s.isFull()&&i.__hasContent&&e.queueTileForDownload(i);return}const n=i.children,o=i.__hasContent,r=Z(i.__loadingState)&&o,a=(e.errorTarget+1)*e.errorThreshold,l=i.__error<=a,c=i.__childrenWereVisible,h=i.__depthFromRenderedParent===0,f=i.__allChildrenLoaded||h;if((l||i.refine==="ADD")&&!r&&!s.isFull()&&o&&e.queueTileForDownload(i),(l&&!f&&!c&&r||i.refine==="ADD"&&r)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),i.refine==="REPLACE"&&l&&!f&&r)for(let p=0,d=n.length;p<d;p++){const m=n[p];M(m,e.frameCount)&&pe(m,e)}else for(let p=0,d=n.length;p<d;p++)ye(n[p],e)}function xe(i,e){const t=M(i,e.frameCount);if(t||i.__usedLastFrame){let s=!1,n=!1;t&&(s=i.__active,e.displayActiveTiles?n=i.__active||i.__visible:n=i.__visible),i.__hasRenderableContent&&i.__loadingState===G&&(i.__wasSetActive!==s&&e.setTileActive(i,s),i.__wasSetVisible!==n&&e.setTileVisible(i,n)),i.__wasSetActive=s,i.__wasSetVisible=n,i.__usedLastFrame=t;const o=i.children;for(let r=0,a=o.length;r<a;r++){const l=o[r];xe(l,e)}}}const se=Symbol("PLUGIN_REGISTERED"),ne=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:i.__inFrustum!==e.__inFrustum?i.__inFrustum?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,Qe=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:i.__lastFrameVisited!==e.__lastFrameVisited?i.__lastFrameVisited>e.__lastFrameVisited?-1:1:i.__hasUnrenderableContent!==e.__hasUnrenderableContent?i.__hasUnrenderableContent?-1:1:i.__error!==e.__error?i.__error>e.__error?-1:1:0;class $e{get root(){const e=this.rootTileSet;return e?e.root:null}set loadSiblings(e){console.warn('TilesRenderer: "loadSiblings" option has been removed.')}set stopAtEmptyTiles(e){console.warn('TilesRenderer: "stopAtEmptyTiles" option has been removed.')}set preprocessURL(e){console.warn('TilesRendererBase: The "preprocessURL" callback has been deprecated. Use a plugin, instead.'),this._preprocessURL=e}get preprocessURL(){return this._preprocessURL}constructor(e=null){this.rootTileSetTriggered=!1,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this._preprocessURL=null;const t=new Ge;t.unloadPriorityCallback=Qe;const s=new te;s.maxJobs=4,s.priorityCallback=ne;const n=new te;n.maxJobs=1,n.priorityCallback=ne,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[se]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");this.plugins.push(e),e[se]=!0,e.init&&e.init(this)}getPluginByName(e){return this.plugins.find(t=>t.name===e)}traverse(e,t){this.root&&_e(this.root,(s,...n)=>(this.ensureChildrenArePreprocessed(s),e?e(s,...n):!1),t)}queueTileForDownload(e){this.queuedTiles.push(e)}update(){const e=this.stats,t=this.lruCache;if(this.rootTileSetTriggered){if(!this.root)return}else{this.invokeOnePlugin(o=>o.loadRootTileSet&&o.loadRootTileSet(this.rootURL));return}const s=this.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,ge(s,this),be(s,this),ye(s,this),xe(s,this);const n=this.queuedTiles;n.sort(t.unloadPriorityCallback);for(let o=0,r=n.length;o<r&&!t.isFull();o++)this.requestTileContents(n[o]);n.length=0,t.scheduleUnload()}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===q&&(t.__loadingState=I)}),e.failed=0)}dispose(){this.invokeAllPlugins(s=>{s!==this&&s.dispose&&s.dispose()});const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.setTileVisible(e,!1),e.__visible=!1),e.__active&&(this.setTileActive(e,!1),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],(n=e.content)!=null&&n.uri){const o=K(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(o&&/json$/.test(o)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=I,e.__loadIndex=0,e.__loadAbort=null,s===null?(e.__depth=0,e.__depthFromRenderedParent=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(o=>{o!==this&&o.preprocessNode&&o.preprocessNode(e,t,s)})}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const o=t[s];if("__depth"in o)break;this.preprocessNode(o,e.__basePath,e)}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[o,r]=n.split(".").map(l=>parseInt(l));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&r>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,s)}loadRootTileSet(e){if(!this.rootTileSetTriggered){this.rootTileSetTriggered=!0;let t=e;this.invokeAllPlugins(n=>t=n.preprocessURL?n.preprocessURL(t,null):t);const s=fetch(t,this.fetchOptions).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${t}" with status ${n.status} : ${n.statusText}`)}).then(n=>{this.preprocessTileSet(n,t),this.rootTileSet=n});return s.catch(n=>{console.error(n),this.rootTileSet=null}),s}}requestTileContents(e){if(e.__loadingState!==I)return;let t=!1,s=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(d=>s=d.preprocessURL?d.preprocessURL(s,e):s);const n=this.stats,o=this.lruCache,r=this.downloadQueue,a=this.parseQueue,l=K(s);if(!o.add(e,d=>{d.__loadingState===B?(d.__loadAbort.abort(),d.__loadAbort=null):t?d.children.length=0:this.invokeAllPlugins(m=>{m.disposeTile&&m.disposeTile(d)}),d.__loadingState===B?n.downloading--:d.__loadingState===H&&n.parsing--,d.__loadingState=I,d.__loadIndex++,a.remove(d),r.remove(d)}))return;e.__loadIndex++;const h=e.__loadIndex,f=new AbortController,_=f.signal;n.downloading++,e.__loadAbort=f,e.__loadingState=B;const p=d=>{e.__loadIndex===h&&(d.name!=="AbortError"?(a.remove(e),r.remove(e),e.__loadingState===H?n.parsing--:e.__loadingState===B&&n.downloading--,n.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(d),e.__loadingState=q):o.remove(e))};return r.add(e,d=>d.__loadIndex!==h?Promise.resolve():fetch(s,Object.assign({signal:_},this.fetchOptions))).then(d=>{if(e.__loadIndex===h){if(d.ok)return l==="json"?d.json():d.arrayBuffer();throw new Error(`Failed to load model with error code ${d.status}`)}}).then(d=>{if(e.__loadIndex===h)return n.downloading--,n.parsing++,e.__loadAbort=null,e.__loadingState=H,a.add(e,m=>m.__loadIndex!==h?Promise.resolve():l==="json"&&d.root?(this.preprocessTileSet(d,s,e),e.children.push(d.root),t=!0,Promise.resolve()):this.invokeOnePlugin(y=>y.parseTile&&y.parseTile(d,m,l,s)))}).then(()=>{e.__loadIndex===h&&(n.parsing--,e.__loadingState=G,o.isFull()?o.remove(e):o.updateMemoryUsage(e))}).catch(p)}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const o=e(t[n]);o&&s.push(o)}return s.length===0?null:Promise.all(s)}}const E=new P;class Xe extends Le{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?E.copy(this.matrix):E.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=E.elements,s=this.matrixWorld.elements;let n=!1;for(let o=0;o<16;o++){const r=t[o],a=s[o];if(Math.abs(r-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(E);const o=this.children;for(let r=0,a=o.length;r<a;r++)o[r].updateMatrixWorld()}}}}const Ye=parseInt(he)<165,j=new P,ve=new ce,Q=new b,z=[];function Te(i,e){return i.distance-e.distance}function Se(i,e,t){Ye?(i.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)}),z.sort(Te)):e.intersectObject(i,!0,t)}function Ze(i,e){Se(i,e,z);const t=z[0]||null;return z.length=0,t}function we(i,e,t,s=null){const{group:n,activeTiles:o}=i;i.ensureChildrenArePreprocessed(e),s===null&&(s=ve,j.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(j));const r=[],a=e.children;for(let h=0,f=a.length;h<f;h++){const _=a[h];if(!_.__used)continue;_.cached.boundingVolume.intersectRay(s,Q)!==null&&(Q.applyMatrix4(n.matrixWorld),r.push({distance:Q.distanceToSquared(t.ray.origin),tile:_}))}r.sort(Te);let l=null,c=1/0;if(o.has(e)){const h=Ze(e.cached.scene,t);h&&(l=h,c=h.distance*h.distance)}for(let h=0,f=r.length;h<f;h++){const _=r[h],p=_.distance,d=_.tile;if(p>c)break;const m=we(i,d,t,s);if(m){const y=m.distance*m.distance;y<c&&(l=m,c=y)}}return l}function Ce(i,e,t,s,n=null){const{group:o,activeTiles:r}=i,{scene:a,boundingVolume:l}=e.cached;if(i.ensureChildrenArePreprocessed(e),n===null&&(n=ve,j.copy(o.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(j)),!e.__used||!l.intersectsRay(n))return;r.has(e)&&Se(a,t,s);const c=e.children;for(let h=0,f=c.length;h<f;h++)Ce(i,c[h],t,s,n)}const D=new b,V=new b,x=new b,O=new ce;class ie{constructor(e=new Be,t=new P){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new P,this.points=new Array(8).fill().map(()=>new b),this.planes=new Array(6).fill().map(()=>new Ie)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,x).distanceTo(e)}containsPoint(e){return x.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(x)}intersectsRay(e){return O.copy(e).applyMatrix4(this.inverseTransform),O.intersectsBox(this.box)}intersectRay(e,t){return O.copy(e).applyMatrix4(this.inverseTransform),O.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:o,max:r}=n;let a=0;for(let l=-1;l<=1;l+=2)for(let c=-1;c<=1;c+=2)for(let h=-1;h<=1;h+=2)e[a].set(l<0?o.x:r.x,c<0?o.y:r.y,h<0?o.z:r.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){D.copy(this.box.min).applyMatrix4(this.transform),V.copy(this.box.max).applyMatrix4(this.transform),x.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(x,D),this.planes[1].setFromNormalAndCoplanarPoint(x,V).negate(),x.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(x,D),this.planes[3].setFromNormalAndCoplanarPoint(x,V).negate(),x.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(x,D),this.planes[5].setFromNormalAndCoplanarPoint(x,V).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const o=s[n];let r=-1/0;for(let a=0;a<8;a++){const l=t[a],c=o.distanceToPoint(l);r=r<c?c:r}if(r<0)return!1}for(let n=0;n<6;n++){const o=this.planes[n];let r=-1/0;for(let a=0;a<8;a++){const l=e.points[a],c=o.distanceToPoint(l);r=r<c?c:r}if(r<0)return!1}return!0}}const w=new b,C=new b,R=new b,oe=new b,re=new b;class Ke{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let o=-1/0,r=-1/0;s&&e.intersectSphere(s,oe)&&(o=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(oe)),n&&n.intersectRay(e,re)&&(r=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(re));const a=Math.max(o,r);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,o=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(o=s.distanceToPoint(e)),n>o?n:o}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new ie;w.set(e[3],e[4],e[5]),C.set(e[6],e[7],e[8]),R.set(e[9],e[10],e[11]);const n=w.length(),o=C.length(),r=R.length();w.normalize(),C.normalize(),R.normalize(),n===0&&w.crossVectors(C,R),o===0&&C.crossVectors(w,R),r===0&&R.crossVectors(w,C),s.transform.set(w.x,C.x,R.x,e[0],w.y,C.y,R.y,e[1],w.z,C.z,R.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-o,-r),s.box.max.set(n,o,r),s.update(),this.obb=s}setSphereData(e,t,s,n,o){const r=new Ee;r.center.set(e,t,s),r.radius=n,r.applyMatrix4(o),this.sphere=r}setRegionData(e,t,s,n,o,r){const a=new We(W,W,He,t,n,e,s,o,r),l=new ie;a.getBoundingBox(l.box,l.transform),l.update(),this.region=a,this.regionObb=l}}const et=new De;function tt(i,e,t,s){const n=et.set(i.normal.x,i.normal.y,i.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-i.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class st extends Ve{constructor(){super(),this.points=Array(8).fill().map(()=>new b)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,o)=>{tt(n[0],n[1],n[2],t[o])})}}function nt(i){const{TextureUtils:e}=Oe;if(!e)return 0;const t=new Set;let s=0;return i.traverse(n=>{if(n.geometry&&!t.has(n.geometry)&&(s+=je(n.geometry),t.add(n.geometry)),n.material){const o=n.material;for(const r in o){const a=o[r];if(a&&a.isTexture&&!t.has(a)){const{format:l,type:c,image:h}=a,{width:f,height:_}=h,p=e.getByteLength(f,_,l,c);s+=a.generateMipmaps?p*4/3:p,t.add(a)}}}}),s}const ae=parseInt(he)<165,Re=Symbol("INITIAL_FRUSTUM_CULLED"),N=new P,$=new P,k=new b,X=new de,it=new b(1,0,0),ot=new b(0,1,0);function le(i,e){i.traverse(t=>{t.frustumCulled=t[Re]&&e})}class rt extends $e{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{le(t,!e)}))}constructor(...e){super(...e),this.group=new Xe(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._eventDispatcher=new Ne,this._upRotationMatrix=new P,this.lruCache.getMemoryUsageCallback=s=>s.cached.bytesUsed||0,this._autoDisableRendererCulling=!0,this._loadingTiles=!1;const t=new ze;if(t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,ae){const s=this;this._overridenRaycast=function(n,o){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,o)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=we(this,this.root,e);s&&t.push(s)}else Ce(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new de),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const o=t.isVector2?t.x:t,r=t.isVector2?t.y:s,a=n.get(e);return(a.width!==o||a.height!==r)&&(a.set(o,r),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(X).multiplyScalar(t.getPixelRatio()),this.setResolution(e,X.x,X.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}preprocessTileSet(e,t,s){super.preprocessTileSet(e,t,s),queueMicrotask(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})})}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(()=>{switch((this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(ot,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(it,Math.PI/2);break}this.dispatchEvent({type:"load-content"})}).catch(()=>{})}update(){let e=null;if(this.invokeAllPlugins(a=>{if(a.doTilesNeedUpdate){const l=a.doTilesNeedUpdate();e=e===null?l:e||l}}),e===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,o=this.cameraInfo;if(s.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;o.length>s.length;)o.pop();for(;o.length<s.length;)o.push({frustum:new st,isOrthographic:!1,sseDenominator:-1,position:new b,invScale:-1,pixelSize:0});$.copy(t.matrixWorld).invert(),k.setFromMatrixScale($);const r=k.x;Math.abs(Math.max(k.x-k.y,k.x-k.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let a=0,l=o.length;a<l;a++){const c=s[a],h=o[a],f=h.frustum,_=h.position,p=n.get(c);(p.width===0||p.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=c.projectionMatrix.elements;if(h.isOrthographic=d[15]===1,h.isOrthographic){const m=2/d[0],y=2/d[5];h.pixelSize=Math.max(y/p.height,m/p.width)}else h.sseDenominator=2/d[5]/p.height;h.invScale=r,N.copy(t.matrixWorld),N.premultiply(c.matrixWorldInverse),N.premultiply(c.projectionMatrix),f.setFromProjectionMatrix(N),_.set(0,0,0),_.applyMatrix4(c.matrixWorld),_.applyMatrix4($)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new P;if(e.transform){const a=e.transform;for(let l=0;l<16;l++)n.elements[l]=a[l]}s&&n.premultiply(s.cached.transform);const o=new P().copy(n).invert(),r=new Ke;"sphere"in e.boundingVolume&&r.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&r.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&r.setRegionData(...e.boundingVolume.region),e.cached={_loadIndex:0,transform:n,transformInverse:o,active:!1,boundingVolume:r,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...e){await super.requestTileContents(...e),this.dispatchEvent({type:"load-content"})}async parseTile(e,t,s,n){const o=t.cached;o._loadIndex++;const r=n.split(/[\\/]/g);r.pop();const a=r.join("/"),l=this.fetchOptions,c=this.manager,h=o._loadIndex;let f=null;const _=o.transform,p=this._upRotationMatrix,d=(qe(e)||s).toLowerCase();switch(d){case"b3dm":{const u=new Me(c);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(p),f=u.parse(e);break}case"pnts":{const u=new ke(c);u.workingPath=a,u.fetchOptions=l,f=u.parse(e);break}case"i3dm":{const u=new Fe(c);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(p),f=u.parse(e);break}case"cmpt":{const u=new Ue(c);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(p),f=u.parse(e).then(v=>v.scene);break}case"gltf":case"glb":{const u=new Ae(c);u.workingPath=a,u.fetchOptions=l,f=u.parse(e);break}default:console.warn(`TilesRenderer: Content type "${d}" not supported.`),f=Promise.resolve(null);break}const m=this.stats;this._loadingTiles===!1&&m.parsing+m.downloading>0&&(this.dispatchEvent({type:"tiles-load-start"}),this._loadingTiles=!0);const y=await f;let g,F;if(y.isObject3D?(g=y,F=null):(g=y.scene,F=y),await this.invokeAllPlugins(u=>u.processTileModel&&u.processTileModel(g,t)),o._loadIndex!==h)return;g.updateMatrix(),(d==="glb"||d==="gltf")&&g.matrix.multiply(p),g.matrix.premultiply(_),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse(u=>{u[Re]=u.frustumCulled}),le(g,!this.autoDisableRendererCulling),ae&&g.traverse(u=>{u.raycast=this._overridenRaycast});const U=[],A=[],L=[];g.traverse(u=>{if(u.geometry&&A.push(u.geometry),u.material){const v=u.material;U.push(u.material);for(const T in v){const S=v[T];S&&S.isTexture&&L.push(S)}}}),o.materials=U,o.geometry=A,o.textures=L,o.scene=g,o.metadata=F,o.bytesUsed=nt(g),this.dispatchEvent({type:"load-model",scene:g,tile:t}),this._loadingTiles===!0&&m.parsing+m.downloading===1&&(this.dispatchEvent({type:"tiles-load-end"}),this._loadingTiles=!1)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,o=t.textures,r=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,l=n.length;a<l;a++)n[a].dispose();for(let a=0,l=s.length;a<l;a++)s[a].dispose();for(let a=0,l=o.length;a<l;a++){const c=o[a];c.image instanceof ImageBitmap&&c.image.close(),c.dispose()}r&&r.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}t._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,o=this.group;t?(o.add(s),n.add(e),s.updateMatrixWorld(!0)):(o.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=this.cameras,n=this.cameraInfo,o=t.boundingVolume;let r=-1/0,a=1/0;for(let l=0,c=s.length;l<c;l++){const h=n[l],f=h.invScale;let _;if(h.isOrthographic){const p=h.pixelSize;_=e.geometricError/(p*f)}else{const d=o.distanceToPoint(h.position)*f,m=h.sseDenominator;_=e.geometricError/(d*m),a=Math.min(a,d)}r=Math.max(r,_)}e.__distanceFromCamera=a,e.__error=r}tileInView(e){const s=e.cached.boundingVolume,n=this.cameraInfo;for(let o=0,r=n.length;o<r;o++){const a=n[o].frustum;if(s.intersectsFrustum(a))return!0}return!1}}[["onLoadTileSet","load-tile-set"],["onLoadModel","load-model"],["onDisposeModel","dispose-model"],["onTileVisibilityChange","tile-visibility-change"]].forEach(([i,e])=>{const t=Symbol(i);Object.defineProperty(rt.prototype,i,{get(){return this[t]||null},set(s){console.warn(`TilesRenderer: "${i}" has been deprecated in favor of the "${e}" event.`),this[t]&&this.removeEventListener(e,this[t]),this[t]=s,this.addEventListener(e,s)}})});export{gt as L,te as P,rt as T,W,He as a,_t as b};
