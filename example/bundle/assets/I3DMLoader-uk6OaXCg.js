import{r as H,F as v,B as G,a as k}from"./readMagicBytes-Da5ueiou.js";import{L as Q}from"./LoaderBase-CVSPpjX2.js";import{k as d,p as B,aH as j,aI as W,Q as $}from"./three.module-CrM3Sdgj.js";import{G as z}from"./GLTFLoader-DesqJ6ah.js";class Z extends Q{parse(r){const s=new DataView(r),a=H(s);console.assert(a==="i3dm");const E=s.getUint32(4,!0);console.assert(E===1);const U=s.getUint32(8,!0);console.assert(U===r.byteLength);const b=s.getUint32(12,!0),A=s.getUint32(16,!0),o=s.getUint32(20,!0),p=s.getUint32(24,!0),f=s.getUint32(28,!0),u=32,y=r.slice(u,u+b+A),n=new v(y,0,b,A),e=u+b+A,c=r.slice(e,e+o+p),L=new G(c,n.getData("INSTANCES_LENGTH"),0,o,p),m=e+o+p,h=new Uint8Array(r,m,U-m);let O=null,l=null,i=null;if(f)O=h,l=Promise.resolve();else{const T=this.resolveExternalURL(k(h)),w=T.split(/[\\/]/g);w.pop(),i=w.join("/"),l=fetch(T,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${T}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>{O=new Uint8Array(t)})}return l.then(()=>({version:E,featureTable:n,batchTable:L,glbBytes:O,gltfWorkingPath:i}))}}const D=new d,R=new d,_=new d,F=new d,C=new $,M=new d,S=new B,x=new B;class Y extends Z{constructor(r=j){super(),this.manager=r,this.adjustmentTransform=new B}resolveExternalURL(r){return this.manager.resolveURL(super.resolveExternalURL(r))}parse(r){return super.parse(r).then(s=>{const{featureTable:a,batchTable:E}=s,U=s.glbBytes.slice().buffer;return new Promise((b,A)=>{const o=this.fetchOptions,p=this.manager,f=p.getHandler("path.gltf")||new z(p);o.credentials==="include"&&o.mode==="cors"&&f.setCrossOrigin("use-credentials"),"credentials"in o&&f.setWithCredentials(o.credentials==="include"),o.headers&&f.setRequestHeader(o.headers);let u=s.gltfWorkingPath??this.workingPath;/[\\/]$/.test(u)||(u+="/");const y=this.adjustmentTransform;f.parse(U,u,n=>{const e=a.getData("INSTANCES_LENGTH"),c=a.getData("POSITION",e,"FLOAT","VEC3"),L=a.getData("NORMAL_UP",e,"FLOAT","VEC3"),m=a.getData("NORMAL_RIGHT",e,"FLOAT","VEC3"),h=a.getData("SCALE_NON_UNIFORM",e,"FLOAT","VEC3"),O=a.getData("SCALE",e,"FLOAT","SCALAR"),l=a.getData("RTC_CENTER");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(t=>{t in a.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${t}" detected.`)});const i=new d;for(let t=0;t<e;t++)i.x+=c[t*3+0]/e,i.y+=c[t*3+1]/e,i.z+=c[t*3+2]/e;const T=[],w=[];n.scene.updateMatrixWorld(),n.scene.traverse(t=>{if(t.isMesh){w.push(t);const{geometry:N,material:I}=t,g=new W(N,I,e);g.position.copy(i),l&&(g.position.x+=l[0],g.position.y+=l[1],g.position.z+=l[2]),T.push(g)}});for(let t=0;t<e;t++){F.set(c[t*3+0]-i.x,c[t*3+1]-i.y,c[t*3+2]-i.z),L?(R.set(L[t*3+0],L[t*3+1],L[t*3+2]),_.set(m[t*3+0],m[t*3+1],m[t*3+2]),D.crossVectors(_,R).normalize(),S.makeBasis(_,R,D),C.setFromRotationMatrix(S)):C.set(0,0,0,1),M.set(1,1,1),h&&M.set(h[t*3+0],h[t*3+1],h[t*3+2]),O&&M.multiplyScalar(O[t]),S.compose(F,C,M).multiply(y);for(let N=0,I=T.length;N<I;N++){const g=T[N],V=w[N];x.multiplyMatrices(S,V.matrixWorld),g.setMatrixAt(t,x)}}n.scene.clear(),n.scene.add(...T),n.batchTable=E,n.featureTable=a,n.scene.batchTable=E,n.scene.featureTable=a,b(n)},A)})})}}export{Y as I};
